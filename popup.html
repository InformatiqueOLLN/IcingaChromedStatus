<!DOCTYPE html>
<html>
<head>
  <style type="text/css">
  body { min-width: 400px; }
  </style>

  <script src="inc/jquery-1.4.2.min.js"></script>

  <link href="inc/jquery-ui/css/smoothness/jquery-ui-1.8.2.custom.css" rel="stylesheet" type="text/css"/>
  <script src="inc/jquery-ui/js/jquery-ui-1.8.2.custom.min.js"></script>

  <link href="icinga.css" rel="stylesheet" type="text/css"/>
  <script src="icinga.js"></script>

<script>
function goto(url) {
  chrome.tabs.create({url: url});

  if ( typeof arguments[1] != "undefined" && arguments[1] === true )
    window.close();
}

function refresh() 
{
  chrome.extension.sendRequest({reqtype: "refresh-data"}, function(response) {
    show();
  });
}

function z(num)
{
  if ( num < 10 ) {
    num = '0'+num;
  }
  return num;
}

function rescheduleService(hostname, servicename)
{
  var t = new Date();
  var time = z(t.getDate()) + '-' + z(t.getMonth()+1) + '-' + z(t.getFullYear()) + '+' + z(t.getHours()) + '%3A' + z(t.getMinutes()) + '%3A' + z(t.getSeconds());
  var dataString = 'cmd_typ=7&cmd_mod=2&host='+ hostname.toLowerCase() + '&service=' + servicename.replace(/ /, "+") + '&start_time='+time+'&force_check=on&submit=Commit';
  debug_log(window.localStorage.url_icinga+'/cmd.cgi'+dataString);
  $.post(window.localStorage.url_icinga+'/cmd.cgi', dataString, function(data, textStatus) { debug_log(textStatus); debug_log(data);});
}
/*
function rescheduleService(hostname, servicename)
{
  goto(window.localStorage.url_icinga+'/cmd.cgi?cmd_typ=7&host='+hostname.toLowerCase()+'&service='+servicename.replace(/ /, "+")+'&force_check');
}
*/

function ackService(hostname, servicename)
{
  goto(window.localStorage.url_icinga+'/cmd.cgi?cmd_typ=34&host='+hostname.toLowerCase()+'&service='+servicename.replace(/ /, "+"));
}
        
function show()
{
  chrome.extension.sendRequest({reqtype: "get-data"}, function(response) {
    if ( response.state == false ) {
      debug_log("We received false response from background");
      debug_log(response.error);

      if ( response.error == 'need-setup' )
        msg = 'You need to <a href="#" onclick="javascript:goto(\'options.html\')">setup this extension</a> first.';
      else if ( response.error == 'bad-auth' )
        msg = 'You need to <a href="#" onclick="javascript:goto(\'options.html\')">setup this extension</a> first.';
      else if ( response.error == 'bad-url' )
        msg = 'URL to status.cgi doesn\'t exists on server, please <a href="#" onclick="javascript:goto(\'options.html\')">setup correct URL</a> first.';
      else if ( response.error = 'unknown' )
        msg = 'Unknown error. Please provide more details about your config to github issue page so I can help you.';
      else
        msg = 'Please wait, data not ready yet.';

      $("#output").html(msg);
      $("#outputHosts").html(msg);
      $("#outputServices").html(msg);
      return;
    }

    debug_log(response.state);

    var oo = '';
    var oh = '';
    var os = '';

    // browse all hosts
    for (var h in response.hosts) {
      var host = response.hosts[h];
      var line = '<tr class="host"><td colspan="2" class="normal"><a href="#" onclick="goto(\''+window.localStorage.url_icinga+'/'+host.link+'\')">'+host.name+'</a></td><td class="state '+stateClass(host.states_all['HOST'])+'">'+stateClass(host.states_all['HOST'], true)+'</td></tr>';

      // add to overview only if not ok
      if ( host.states_all['HOST'] > 0 || host.states_all['WRONG'] > 0 )
        oo += line;

      oh += line;
      os += line;

      // browse all services of host
      for (var s in host.services ) {
        var service = host.services[s];
        //var reschedule='<a title="Immediately reschedule check of this service" class="ui-icon ui-icon-refresh" href="#" onclick="rescheduleService(\''+host.name+'\',\''+service.name+'\')">resch</a>';
        var reschedule='<a title="Reschedule check of this service" class="ui-icon ui-icon-refresh" href="#" onclick="rescheduleService(\''+host.name+'\',\''+service.name+'\')">resch</a>';
        var ack='<a title="Acknowledge this problem" class="ui-icon ui-icon-wrench" href="#" onclick="ackService(\''+host.name+'\',\''+service.name+'\')">ack</a>';

        var line = '<tr class="service"><td style="width: 30px;">&nbsp;</td><td class="normal" style="white-space: nowrap;"><a href="#" onclick="goto(\''+window.localStorage.url_icinga+'/'+service.link+'\')">'+service.name+(service.ack?'&nbsp;<span class="ui-icon ui-icon-check" style="float: right;" title="Acknowledged">&nbsp;</span>':'')+'</td><td class="state '+stateClass(service.state)+'">'+stateClass(service.state, true)+'</td><td class="tools">'+reschedule+(service.ack || service.state == 0 ? '' : ack)+'</td></tr>';


        // add to overview only if not ok
        if ( service.state > 0 )
          oo += line;

        os += line;
      }
    }

    oo = '<br /><h3>Problems on hosts and services</h3><table id="tableOverview">'+oo+'</table>';

    var ot = '<div id="totalsHosts"><h3>Host Status</h3><table>'+
       '<tr><th>Up</th><th>Down</th><th>Unr</th><th>Pend</th></tr>'+
       '<tr>'+
       '<td class="ok">'+response.totals_hosts[0]+'/'+response.totals_all_hosts[0]+'</td>'+
       '<td class="cri">'+response.totals_hosts[8]+'/'+response.totals_all_hosts[8]+'</td>'+
       '<td class="unr">'+response.totals_hosts[4]+'/'+response.totals_all_hosts[4]+'</td>'+
       '<td class="pend">'+response.totals_hosts[1]+'/'+response.totals_all_hosts[1]+'</td>'+
       '</tr></table></div>';

    ot = ot + '<div id="totalsServices"><h3>Service Status</h3><table>'+
       '<tr><th>Ok</th><th>Warn</th><th>Unkn</th><th>Crit</th><th>Pend</th></tr>'+
       '<tr>'+
       '<td class="ok">'+response.totals_services[0]+'/'+response.totals_all_services[0]+'</td>'+
       '<td class="warn">'+response.totals_services[4]+'/'+response.totals_all_services[4]+'</td>'+
       '<td class="unkn">'+response.totals_services[2]+'/'+response.totals_all_services[2]+'</td>'+
       '<td class="cri">'+response.totals_services[8]+'/'+response.totals_all_services[8]+'</td>'+
       '<td class="pend">'+response.totals_services[1]+'/'+response.totals_all_services[1]+'</td>'+
       '</tr></table></div><br class="clear" />';


    $("#output").html(ot+oo)
    $("#outputHosts").html('<table id="tableHosts">'+oh+'</table>');
    $("#outputServices").html('<table id="tableServices">'+os+'</table>');
  });
}

// document is ready, we can start
$(document).ready(function() {
  // show tabs
  $("#tabs").tabs();

  // draw screen
  show();

});

</script>
</head>
<body>
<div id="control">
  <a href="#" onclick="javascript:refresh()">Refresh Data</a> | 
  <a href="#" onclick="javascript:goto('options.html')">Options</a>
</div>

<div id="tabs">
  <ul>
    <li><a href="#tab-1"><span>Overview</span></a></li>
    <li><a href="#tab-2"><span>Hosts</span></a></li>
    <li><a href="#tab-3"><span>Services</span></a></li>
    <li><a href="#tab-4"><span>About</span></a></li>
  </ul>

  <div id="tab-1">
    <div id="output"></div>
  </div>
  <div id="tab-2">
    <h3>Hosts status</h3>
    <div id="outputHosts"></div>
  </div>
  <div id="tab-3">
    <h3>Services status</h3>
    <div id="outputServices"></div>
  </div>
  <div id="tab-4">
    <h3>Icinga Chromed Status</h3>

    <p><strong>This extension is Alpha quality and provided as is, for my testing purposes mainly.</strong></p>

    <p>Icinga Chromed Status should help monitor status of hosts and their services while using Icinga or Nagios (not tested) monitoring software.</p>

    <p>Author of this extension is <a href="http://kepi.cz/">Ondra 'Kepi' Kudl√≠k</a> kindly sponsored by <a href="http://www.igloonet.cz/">IglooNET.cz</a> company.</p>
  </div>
</div>
</body>
</html>

